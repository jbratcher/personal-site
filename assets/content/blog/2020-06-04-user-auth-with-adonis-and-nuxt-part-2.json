{
  "date": "2020-06-04T13:14:05.756Z",
  "body": "Last time we set up a basic user authentication workflow that allowed us to register, login, and logout users and sync the state data between the server and client.\n\n[Previous post](https://www.jeremybratcher.com/blog/2020-05-27-user-auth-with-adonis-and-nuxt)\n\nNext, we will be building upon this functionality with the following:\n\n* Allowing newly registered users to verify their accounts\n* Allowing users to reset a forgotten password\n* Allowing users to update their profile information and change their password\n\n### Extending the base user functionality\n\nEven the most basic user management workflow still needs to do things like sign-up verification like sending an email to the register user's email address that contains a link to click to verify the new account.\n\nUsers will inevitably need a forgot password action as well as the ability to reset a password.\n\nIt may not always be necessary but this starter project does include a light profile management ability as well.\n\n### Account Verification\n\nVerifying a newly registered users account via email is a common practice and [has many benefits](https://ux.stackexchange.com/questions/111005/what-is-the-point-of-email-verification). Adonis and it's official modules make this task easy to implement.\n\nAdonis Persona sets the `account_status` of the user to `pending` upon registration and also emits a `user::created` event which we can target to generate a verification email to send to the user.\n\n#### Configuring the email provider\n\nSetting up an email provider for small projects can be a challenge especially when it's hard to find a free provider. Luckily, Gmail now offers the ability to use your [gmail address as an SMTP mail server](https://support.google.com/a/answer/176600?hl=en). You can send around 500 emails per day for free with this service with is perfect for development and testing.\n\nWe are using the [Adonis Mail module](https://adonisjs.com/docs/4.1/mail) which needs to be installed.\n\n`npm install @adonisjs/mail`\n\nThen register the mail provider in `start/app.js`\n\n```javascript\nconst providers = [\"@adonisjs/mail/providers/MailProvider\"];\n```\n\nAdonis Mail uses SMTP by default which is what we need. We do need to configure it to use Gmail.\n\nIn `config/mail.js`, change the `smtp` options to the following:\n\n```javascript\nsmtp: {\n    driver: \"smtp\",\n    pool: true,\n    port: Env.get(\"SMTP_PORT\", 2525),\n    host: Env.get(\"SMTP_HOST\"),\n    secure: true,\n    auth: {\n      user: Env.get(\"MAIL_USERNAME\"),\n      pass: Env.get(\"MAIL_PASSWORD\")\n    },\n    maxConnections: 5,\n    maxMessages: 100,\n    rateLimit: 10\n  },\n```\n\n`secure: true` is needed for the connection to work.\n\nHere is an example `.env` with the mail ENV variables:\n\n```javascript\nMAIL_CONNECTION=smtp  // redundant since default\nSMTP_PORT=465  // gmail port\nSMTP_HOST=smtp.gmail.com  // gmail host\nMAIL_USERNAME=yourname@gmail.com  // gmail email address\nMAIL_PASSWORD=Y0urPa$$word  // gmail password\n```\n\nYou may also need to [change your app access](https://myaccount.google.com/lesssecureapps) for your Google account to be able to send mail from a local development server. If you don't want to do this on your main account, you can always register a new gmail address for this.\n\n#### Sending Mail To New Users\n\nNow that the mail provider is configured, we can email new users a account verification link with their token.\n\n[Adonis Events](https://adonisjs.com/docs/4.1/events) is installed with Adonis but we will need to create an `events.js` file in the start folder.\n\nIn `start/events.js`:\n\n```javascript\nconst querystring = require(\"querystring\");\nconst Env = use(\"Env\");\nconst Event = use(\"Event\");\nconst Mail = use(\"Mail\");\n\n// on new user registration, send email verification link\nEvent.on(\"user::created\", async (payload) => {\n  const user = payload.user.toJSON();\n  const token = querystring.encode({\n    token: payload.token,\n  });\n\n  await Mail.send(\"new.user\", { user, token }, (message) => {\n    message\n      .to(payload.user.email)\n      .from(`<${Env.get(\"MAIL_USERNAME\")}>`)\n      .subject(\"Thanks for registering!\");\n  });\n});\n```\n\nHere we are defining a new event to trigger when the `user::created` event is fired. Persona automatically fires a `user::created` event when Persona.register() from the User controller is called.\n\nPersona.register() returns an object containing the user and token which will be modified then passed to the edge template for the email.\n\nThe user object will need to be converted to JSON to user in the email template. This is done with the `.toJSON()` method.\n\nThe email token is generated during registration by Adonis Persona. This token can be included in a link in the email which authenticates the user when verifying their account. `querystring`, a Node.js method, is used to properly encode the generated token for use in a url. This is necessary because the generated token can contain characters (like slashes) that won't be [read correctly in a url](https://forum.adonisjs.com/t/adonis-persona-verifyemail-400-error-the-token-is-invalid-or-expired/6466).\n\n##### Creating the email template\n\nIn the `resources` folder create a folder `new`.\n\nInside `new`, create a file `user.edge`.\n\nNow, we can reference the template as `new.user`.\n\nLet's create the email template.\n\nIn `user.edge`:\n\n```javascript\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\" />\n  <title>New User Registration</title>\n</head>\n<body>\n  <section>\n      <p>\n        Welcome, {{ user.full_name }}. Thanks for registering. Please click the link below to verify your email and activate your account.\n      </p>\n    <a href=\"http://localhost:3000/users/verify-email?{{token}}\">Verify your email</a>\n  </section>\n</body>\n</html>\n```\n\nThis basic example just welcomes the user by name and displays a link containing their token to verify their email. The link should trigger a request to the server (see the `verifyEmailWithToken` method in `store/index.js`)\n\nLet's look at the `verifyEmailWithToken` method.\n\nIn `store/index.js`:\n\n```javascript\nexport const actions = {\n  // verify a newly created user's account from an email token link\n  async verifyEmailWithToken({ commit }, token) {\n    await this.$axios\n      .$get(`/auth/verify-email?token=${token}`)\n      .then((response) => console.log(response))\n      .catch((e) => console.log(e));\n  },\n};\n```\n\nThis method makes a get request with the token to the User Controller method `verifyEmail`. This method will use the token to verify the user using `Persona.verifyEmail()`.\n\nIn `app/Controllers/UserController.js`\n\n```javascript\n// verify a new user's account by token\nasync verifyEmail({ request, params, session, response }) {\n  const token = request.input(\"token\");\n  const user = await Persona.verifyEmail(token);\n  session.flash({ message: \"Email verified\" });\n  return user;\n}\n```\n\n`request.input(\"token\")` is used since the token is being passed as a query param in the url.\n\n`Persona.verifyEmail(token)` will change the user's `account_status` from `pending` to `active` and remove the email token from the tokens table.\n\nNow the user's account has been properly activated.\n\n### Conclusion\n\nI'm going to split the rest of the functions into their own post since they are long and detailed. Up next week will be how to implement a forgot password and password reset functionality. After that, we will wrap up the series with how to allow uses to edit their profiles and change their password.",
  "title": "User Auth with Adonis and Nuxt, Part 2",
  "description": "Account verification",
  "thumbnail": "/img/adonis-nuxt-starter.svg",
  "hero": "/img/adonis-nuxt-starter.svg"
}