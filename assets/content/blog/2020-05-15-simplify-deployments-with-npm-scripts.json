{
  "date": "2020-05-15T16:08:09.879Z",
  "title": "Simplify Deployments With NPM Scripts",
  "description": "Workflow automation to merge, release, and deploy",
  "thumbnail": "/img/devops.svg",
  "hero": "/img/devops.svg",
  "body": "# Simplify Deployments With NPM Scripts\r\n\r\n## Combining workflow scripts to save time\r\n\r\nI typically work out of a `dev` branch when developing a new feature or a bug fix. When I'm ready to add this code to my repo, I'll add and commit in the `dev` branch and merge the code to both a `master` and `staging` branch. `master` for a root branch and `staging` as a pre-deployment branch. When I'm ready to deploy, I'll merge `staging` to each deployment branch (`server` and `client` in a monorepo) and push the changes to a cloud service that runs build and deploy scripts.\r\n\r\nUsing Git in the command line, this can result in a lot of typing especially since I'm a fan of smaller commits and frequent deployments. To save my self some time and sanity, I created a set of scripts in `package.json` which boil down a handful or commands to a single command.\r\n\r\n###### Note that this workflow omits linting and testing steps as I do this in the `dev` branch before releasing code. If your workflow is different, it should be easy to add or modify these steps to include other commands.\r\n\r\nTo begin, I broke down the steps I took every time I wanted to take a simple action that required multiple typed commands.\r\n\r\nFor example, when completing a new feature in my `dev` branch, I want to merge the branch with my `master` branch when I want to store the code and to my `staging` branch for when that feature is ready to be released.\r\n\r\nTo do this I have to:\r\n\r\n- checkout the `master` branch,\r\n- merge the `dev` branch to `master`,\r\n- push the changes to `origin/master`,\r\n- checkout the `staging` branch,\r\n- merge the `dev` branch to `staging`\r\n- push the changes to `origin/staging`,\r\n\r\nIt becomes apparent that automating this process with a single command is needed when you do this task frequently. Note that I am adding, committing and pushing the code from the `dev` branch manually before any of these commands are run.\r\n\r\nIn `package.json`:\r\n\r\n```js\r\n{\r\n  \"name\": \"nuxt-deploy-workflow\",\r\n  \"version\": \"4.1.0\",\r\n  \"adonis-version\": \"4.1.0\",\r\n  \"description\": \"Better manage your deployment workflow using scripts\",\r\n  \"scripts\": {\r\n    \"_comment\": \"merge commands\",\r\n    \"merge-dev:master\": \"git checkout master && git merge dev && git push origin master\",\r\n    \"merge-dev:staging\": \"git checkout staging && git merge dev && git push origin staging\",\r\n    \"merge-dev:release\": \"npm run merge-dev:master && npm run merge-dev:staging\",\r\n    \"merge-staging:heroku\": \"git checkout heroku && git merge staging\",\r\n    \"merge-staging:netlify\": \"git checkout netlify && git merge staging\",\r\n    \"merge-staging:release\": \"npm run merge-staging:heroku && npm run merge-staging:netlify\",\r\n  },\r\n  \"author\": \"Your Name\",\r\n  \"license\": \"MIT\",\r\n  \"private\": false\r\n}\r\n\r\n```\r\n\r\nNow if I run `merge-staging:release` from the command line using `npm run`, the script will sequentially run each command merging the new feature to each branch and pushing the update to the online repo.\r\n\r\nThe scripts for the deployment are similar to the merge commands.\r\n\r\nTo deploy code to both Heroku and Netlify:\r\n\r\n- run all merge commands\r\n- push `heroku` to `heroku/master`\r\n- checkout `staging` branch\r\n- push `netlify` to `origin/netlify`\r\n- checkout `staging` branch\r\n\r\nI'm checking the `staging` branch after each command for cases where I run them individually.\r\n\r\nIn `package.json`:\r\n\r\n```js\r\n    \"release:heroku\": \"git subtree push --prefix server heroku master && git checkout staging\",\r\n    \"release:netlify\": \"git push origin netlify && git checkout staging\",\r\n    \"deploy:client\": \"npm run merge-dev:release && npm run merge-staging:netlify && npm run release:netlify\",\r\n    \"deploy:server\": \"npm run merge-dev:release && npm run merge-staging:heroku && npm run release:heroku\",\r\n    \"deploy:all\": \"npm run deploy:client && npm run deploy:server\"\r\n```\r\n\r\nThe deploy commands are building on top of the merge and release commands. `deploy:all` will run all of the commands allowing me to merge, push and deploy a new feature with one command from the `dev` branch.\r\n\r\nPutting this all together, in `package.json`:\r\n\r\n```js\r\n{\r\n  \"name\": \"nuxt-deploy-workflow\",\r\n  \"version\": \"4.1.0\",\r\n  \"adonis-version\": \"4.1.0\",\r\n  \"description\": \"Better manage your deployment workflow using scripts\",\r\n  \"scripts\": {\r\n    \"_comment\": \"merge commands\",\r\n    \"merge-dev:master\": \"git checkout master && git merge dev && git push origin master\",\r\n    \"merge-dev:staging\": \"git checkout staging && git merge dev && git push origin staging\",\r\n    \"merge-dev:release\": \"npm run merge-dev:master && npm run merge-dev:staging\",\r\n    \"merge-staging:heroku\": \"git checkout heroku && git merge staging\",\r\n    \"merge-staging:netlify\": \"git checkout netlify && git merge staging\",\r\n    \"merge-staging:release\": \"npm run merge-staging:heroku && npm run merge-staging:netlify\",\r\n    \"release:heroku\": \"git subtree push --prefix server heroku master && git checkout staging\",\r\n    \"release:netlify\": \"git push origin netlify && git checkout staging\",\r\n    \"deploy:client\": \"npm run merge-dev:release && npm run merge-staging:netlify && npm run release:netlify\",\r\n    \"deploy:server\": \"npm run merge-dev:release && npm run merge-staging:heroku && npm run release:heroku\",\r\n    \"deploy:all\": \"npm run deploy:client && npm run deploy:server\"\r\n  },\r\n  \"author\": \"Your Name\",\r\n  \"license\": \"MIT\",\r\n  \"private\": false\r\n}\r\n```\r\n"
}