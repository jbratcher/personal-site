{
  "date": "2020-03-04T18:40:31.898Z",
  "title": "External API Requests with ASP.NET Core 3.1",
  "description": "3rd-party API consumption example",
  "body": "Using external APIs is so commonplace in web development it is high on the list of necessary skills and skills to learn in any tech stack.  Since I've been building things with ASP.NET Core, I wanted to figure out how to work with 3rd-party APIs as soon as possible.  I've used these in the past for several projects including [VoteInfo](https://www.jeremybratcher.com/portfolio/2020-01-10-voteinfo) and [ShouldIRun](https://www.jeremybratcher.com/portfolio/2020-01-10-should-i-run) as public APIs are easy to use and provide powerful data to work with for web applications.\n\nComing from the JavaScript world, simple API requests to retrieve and work with JSON boil down to just a handful of lines of code.  Using ASP.NET Core, much more code is required for even simple request but the benefits of using a robust ecosystem, enterprise support and explicit typing outweigh the extra set up time.\n\nBelow is a copy of the repo's readme file which walks you though how to set up a simple http request to an external API with the response being saved to the database and displayed on the page.\n\n# ASP.NET Core 3.1 External API Request\n\nA simple MVC app to show examples of how to consume an external API using ASP .NET Core 3.1\n\nFeatures:\n\n* Fetch data with a simple Http request\n* Fetch data using authorization\n* Display data on a Razor page\n* Save data using EFCore  \n\n\n\n## A simple request\n\nThe [JSONPlaceholder](https://jsonplaceholder.typicode.com/) API allows for rapid prototyping against a fake online REST API.  This example uses the Photos endpoint provided by the API.\n\nAn onine service [json2csharp](http://json2csharp.com/) allows for easy creation of a C# model from the JSON data.  JSON data can simply be copy/pasted into a field and a C# model will be generated that represents the data.\n\nSteps:\n\n* Create an ASP.NET Core MVC app using Visual Studio template\n* Add EFCore and SQL Server to project via Nuget Package Manager\n* Add Photo.cs to the Models folder\n* Add the following code to Photo.cs\n\n```cs\nnamespace ASPNETCoreExternalAPIRequest.Models\n{\n    public class Photo\n    {\n        public class RootObject\n        {\n            public int albumId { get; set; }\n            public int id { get; set; }\n            public string title { get; set; }\n            public string url { get; set; }\n            public string thumbnailUrl { get; set; }\n        }\n\n    }\n}\n```\n\n* Add a Data folder\n* In the Data folder, add a file named ApplicationDbContext.cs\n* Add the following code to ApplicationDbContext.cs\n\n```cs\nusing Microsoft.EntityFrameworkCore;\nusing ASPNETCoreExternalAPIRequest.Models;\n...\nnamespace ASPNETCoreExternalAPIRequest.Data\n{\n    public class ApplicationDbContext : DbContext\n\n    {\n        public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)\n            : base(options)\n        {\n        }\n        public DbSet<Photo> Photos{ get; set; }\n    }\n}\n```\n\nThe ApplicationDbContext will inherit from the base DbContext.\\\nDbSet<Photo> will hold a list of Photos from the database.\n\n* Add the following code to Startup.cs\n\n```cs\nusing ASPNETCoreExternalAPIRequest.Data;\nusing Microsoft.EntityFrameworkCore;\n...\npublic void ConfigureServices(IServiceCollection services)\n{\n    services.AddDbContext<ApplicationDbContext>(options =>\n        options.UseSqlServer(\n            Configuration.GetConnectionString(\"DefaultConnection\")));\n}\n```\n\n* Add the following code to appsettings.json\n\n```cs\nConnectionStrings\": {\n    \"DefaultConnection\": \"Server=(localdb)\\\\mssqllocaldb;Database=ASPNETCoreExternalAPIRequest-1;Trusted_Connection=True;MultipleActiveResultSets=true\"\n}\n```\n\n* Scaffold a MVC controller with CRUD pages\n* Add New Scaffolded Item -> MVC Controller with Views, using Entity Framework -> enter the model -> enter the database context -> Add\n* Run the initial migration\n* From the Package Manager Console: \n* Add-Migration InitialCreate\n* Update-Database\n* In Shared/_Layout.cshtml, add a link to the photos index page\n\n```html\n<li class=\"nav-item\">\n    <a class=\"nav-link text-dark\" asp-area=\"\" asp-controller=\"Photos\" asp-action=\"Index\">Photos</a>\n</li>\n```\n\n* Install Newtonsoft.Json and Microsoft.AspNetCore.Mvc.NewtonsoftJson via the Nuget Package Manager\n* Update Startup.ConfigureServices to call AddNewtonsoftJson.\n\n```cs\n    services.AddMvc().AddNewtonsoftJson();\n```\n\n* In the PhotosController, add the following using statements and a new method to fetch the data\n\n```cs\nusing System.Net.Http;\nusing Newtonsoft.Json.Linq;\n...\npublic async Task<IActionResult> FetchPhotos()\n{\n\n    using (var client = new HttpClient())\n    {\n        // build request \n        client.BaseAddress = new Uri(\"https://jsonplaceholder.typicode.com/\");\n        client.DefaultRequestHeaders.Add(\"Accept\", \"application/json\");\n        var response = await client.GetAsync($\"/photos?_start=0&_limit=10\");\n        response.EnsureSuccessStatusCode();\n\n        // convert request to list of Photos\n        var photos = await response.Content.ReadAsStringAsync();\n        JArray photoSearch = JArray.Parse(photos);\n        IList<JToken> results = photoSearch.Children().ToList();\n        IList<Photo> searchResults = new List<Photo>();\n\n        // update photo or add if not exists\n        foreach (JToken result in results)\n        {\n            // JToken.ToObject is a helper method that uses JsonSerializer internally\n            Photo searchResult = result.ToObject<Photo>();\n            searchResults.Add(searchResult);\n\n            if (!PhotoExists(searchResult.Id))\n            {\n                _context.Add(searchResult);\n            }\n            else\n            {\n                _context.Update(searchResult);\n            }\n\n            // since id is being set by api call need to toggle identity on before saving\n            _context.Database.OpenConnection();\n\n            try\n            {\n                _context.Database.ExecuteSqlRaw(\"SET IDENTITY_INSERT dbo.Photos ON\");\n                _context.SaveChanges();\n                _context.Database.ExecuteSqlRaw(\"SET IDENTITY_INSERT dbo.Photos OFF\");\n            }\n            finally\n            {\n                _context.Database.CloseConnection();\n            }\n\n            await _context.SaveChangesAsync();\n        }\n\n        return Redirect(\"/Photos\");\n\n    }\n}\n```\n\nThere is a lot going on here so let's break it down.\n\n* Using HttpClient, we set the base url and accept header.  \n* Then we make the request (notice the start and limit query parameters) and ensure it is a valid response code.\n* Next we take the response string (which is a Json Array in string format) and convert it to a Json array.\n* Set the resulting Json array to a JTokens list which captures each object in the Json array as a seperate item.\n* Also set a List of Photos variable to hold the list in the next step\n* Next iterate over each item in the json array, convert it to a Photo C# object and add it to list we are building.\n* upsert function to check if item is already in database.\n* Identity insert used since Id is not being set by EF Core but the incoming json (https://entityframeworkcore.com/saving-data-identity-insert).  \n\n\n\nOnce these steps are completed, build the project and navigate to the Photos page and click on the Update Photos link. This will call the API and upsert the results into to the database.  Then the page is redirected to the Photos page for a refresh and the Photo objects will be displayed.",
  "thumbnail": "/img/asp-net-core-identity-config.svg",
  "hero": "/img/asp-net-core-identity-config.svg"
}