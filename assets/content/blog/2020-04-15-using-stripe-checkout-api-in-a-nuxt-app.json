{
  "date": "2020-04-15T23:34:09.128Z",
  "title": "Using Stripe Checkout API In A Nuxt App",
  "description": "Easy setup using CDN and Vue Mixins",
  "body": "[Repo for this post](https://github.com/jbratcher/stripe-client-only-checkout)\n\nA recent project of mine needed a quick solution for payment collection and I decided to use [Stripe](https://stripe.com/)'s API since it provides an easy way to set this up. This project is using [Nuxt](https://nuxtjs.org) with [Netlify](https://www.netlify.com/) for CI/CD and hosting which I've come to really enjoy using to develop over the last few months. If you aren't familiar with Netlfiy, it will allow you to host a static Nuxt website that can be git pushed to deployment. I just write the code and push it to my Github repo and Netlify builds, generates, deploys, and hosts the site.\r\n\r\nNetlify does offer Lamda Functions with AWS but I haven't used them much and knew that Stripe's API is developer friendly enough simply to load via CDN.\r\n\r\nSince this is a static site, we won't be able to use Stripe Checkout's session but we will be using a Stripe hosted page that is designed to make sales as easy for the user. Checkout will allow us to redirect the user back to our site after the purchase is either completed or cancelled.\r\n\r\n### Getting Started\r\n\r\nTo use Stripe, you will need to [sign up](https://dashboard.stripe.com/register) with them and activate your account. The sign up require some information but is painless and quick to complete.\r\n\r\nOnce your Stripe account is activated, you can [enable Checkout from the dashboard](https://stripe.com/docs/payments/checkout/client#enable-checkout).\r\n\r\nGo ahead and change to test mode for development. This can can be done by toggling the 'View Test Data' button on the Stripe Dashboard.\r\n\r\nNext, create a product and and allow it to be used with Checkout. New products can be created from the Dashboard under Products.\r\n\r\nWhen you click 'Use With Checkout`, a dialog will open with a copy/paste template to be used on an html page. We won't need this as we are using a modified version of this method.\r\n\r\nCopy the generated sku from the item listing. The sku will be used by the checkout method in the Vue mixin and component.\r\n\r\n### Loading Stripe via CDN\r\n\r\nWe are using the Stripe CDN for simplicity's sake but you can also locally [install Stripe via npm](https://www.npmjs.com/package/stripe).\r\n\r\nIn `nuxt.config.js`:\r\n\r\n```javascript\nexport default {\r\n    head: {\r\n        ...,\r\n        script: [\r\n            {\r\n                src: 'https://js.stripe.com/v3',\r\n                defer: true\r\n            }\r\n        ]\r\n    }\r\n}\r\n```\r\n\r\nNormally, we would only load a 3rd party script on the specific pages that would use it to reduce unnecessary page load but Stripe recommends loading the script on every page ['to best leverage Stripe's advanced fraud functionality'](https://stripe.com/docs/js/including).\r\n\r\nWe are setting defer to true to prevent the script from blocking the render of the page.\r\n\r\n### Create the Vue Mixin for the Checkout method\r\n\r\nVue mixins are good for reducing code redundancy as they just need to be imported into the component. Using this workflow allows you to set the arguments for the mixin method inside the component to enhance reusability.\r\n\r\nFirst, create a file named `stripeCheckoutMixin.js` in the `mixins` folder. If you don't already have a `mixins` folder, you can create it at the top level of your project.\r\n\r\nIn `stripeCheckoutMixin.js`:\r\n\r\n```javascript\nexport default {\r\n  methods: {\r\n    checkout: function(event) {\r\n      this.stripe\r\n        .redirectToCheckout({\r\n          items: [{ sku: this.sku, quantity: 1 }],\r\n          // Todo: handle fullfillment\n          // https://stripe.com/docs/payments/checkout/fulfillment\r\n          successUrl: this.successUrl,\r\n          cancelUrl: this.cancelUrl\r\n        })\r\n        .then(function(result) {\r\n          if (result.error) {\r\n            var displayError = document.getElementById('error-message')\r\n            displayError.textContent = result.error.message\r\n          }\r\n        })\r\n    }\r\n  },\r\n  mounted() {\r\n    this.stripe = Stripe(process.env.STRIPE_PUBLISHABLE_KEY)\r\n  }\r\n}\r\n```\r\n\r\nBasically, we are passing some options in an object that represent the item we created previously and urls to redirect to after finishing.\r\n\r\nThe stripe data variable is being set in the mounted function to ensure it stays around during page refresh of the component. If otherwise set outside this hook, Stripe() will not be found on page refresh.\r\n\r\nThe stripe documentation explains the [redirectToCheckout](https://stripe.com/docs/js/checkout/redirect_to_checkout) method fully.\r\n\r\n### Using environment variables in Nuxt\r\n\r\n(You can find your stripe publishable key from your Stripe Dashboard home page via 'Get your test API keys')\r\n\r\nTo easily access `process.env.STRIPE_PUBISHABLE_KEY`, I'm using the dotenv package for Nuxt, @nuxtjs/dotenv.\r\n\r\n`npm install --save-dev @nuxtjs/dotenv`\r\n\r\nRegister the module in the build modules section of `nuxt.config.js`:\r\n\r\n```javascript\nexport default {\r\n    ...,\r\n    /*\r\n    ** Nuxt.js dev-modules\r\n    */\r\n    buildModules: ['@nuxtjs/dotenv'],\r\n}\r\n```\r\n\r\nThis module allows you easily access variables from your `.env` file without exposing them publicly. Make sure you include your `.env` file in your `.gitignore` file to prevent these from being tracked by your repo.\r\n\r\nBack in `stripeCheckoutMixin.js`:\r\n\r\n```javascript\nexport default {\r\n    ...,\r\n    mounted() {\r\n        this.stripe = Stripe(process.env.STRIPE_PUBLISHABLE_KEY)\r\n    }\r\n}\r\n```\r\n\r\nHere we are using the dotenv package to access the variable with the standard pattern of `process.env.ENV_VARIABLE_NAME`. In this case, Caps are used to represent a constant.\r\n\r\n### Adding a Purchase Button to the Component\r\n\r\nTo redirect to the checkout from our product page, we will add a purchase button with a click handler.\r\n\r\n```javascript\n<template>\r\n  <button\r\n    @click=\"checkout\"\r\n    role=\"link\">\r\n        Purchase this package\r\n    </button>\r\n</template>\r\n<script>\r\n    import 'stripeCheckoutMixin' from './mixins/stripeCheckoutMixin'\r\n    export default {\r\n        mixins: [stripeCheckoutMixin],\r\n        data: () => {\r\n            sku: 'sku_from_stripe_dashboard_product_listing',\r\n            successUrl: '/item-purchase/success',\r\n            cancelUrl: '/item-purchase/cancel'\r\n        })\r\n    }\r\n</script>\r\n```\r\n\r\nHere we are adding a click event to the button and setting it's role to link since we are linking to an external url at stripe to complete the process.\r\n\r\nIn the script section, the mixin is being imported and registered with the Vue component.\r\n\r\nIn the data section, each argument to be passed to the checkout method (in the mixin) is set for the item.\r\n\r\nUsing this set up, when the purchase button is clicked, the user is redirected from our page to the stripe checkout page. The checkout page is populated with the product info and provides a section to easily gather the user payment info and process the payment.\r\n\r\n### Conclusion\r\n\r\nThis serves as a quick and painless way to set up payment processing for a product being served on a static site using Nuxt.\r\n\r\nThis script can be easily modified to add more items or more checkout options.\r\n\r\nStripe documentation refers to this set up as a [client-only integration](https://stripe.com/docs/payments/checkout/client) and provides a step-by-step walk-through. You can read that page for more information on how Stripe Checkout works. My method is adapted from this page for use with Nuxt.\r\n",
  "thumbnail": "/img/nuxt-stripe.svg",
  "hero": "/img/nuxt-stripe.svg"
}