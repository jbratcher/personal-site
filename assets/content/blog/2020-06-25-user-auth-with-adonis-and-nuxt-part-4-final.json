{
  "date": "2020-06-25T17:49:49.490Z",
  "title": "User Auth with Adonis and Nuxt, Part 4 (Final)",
  "body": "### Profile Editing / Change Email / Change Password\r\n\r\nLast time, we set up a common, useful feature allowing the user to request a password reset and complete a password change. Today, we will be wrapping up this series on user authentication and authorization. The final features that will finish this project are the ability to edit the user's profile, change their email, and change their password.\r\n\r\n[Previous Post](https://www.jeremybratcher.com/blog/2020-06-15-user-auth-with-adonis-and-nuxt-part-3)\r\n\r\n## Table of Contents\r\n\r\n- [Profile editing](#markdown-header-profile_editing)\r\n  - [Creating the profile layout](#markdown-header-creating_the_profile_page_layout)\r\n  - [Creating the profile view](#markdown-header-creating_the_profile_view)\r\n    - [Adding the edit menu](#markdown-header-adding_the_edit_menu)\r\n    - [Finishing the user profile view](#markdown-header-finishing_the_user_profile_view)\r\n    - [Breaking down the profile view](#markdown-header-breaking_down_the_profile_view)\r\n    - [Updating the user profile](#markdown-header-updating_the_user_profile)\r\n    - [Updating the user profile image](#markdown-header-updating_the_user_profile_image)\r\n- [Change email](#markdown-header-change_email)\r\n- [Change password](#markdown-header-change_password)\r\n\r\nThe code from this series is part of my ongoing project [Adonis Nuxt Starter](https://github.com/jbratcher/Adonis-Nuxt-Starter)\r\n\r\n## Profile editing\r\n\r\nThe first step we want to take is to create a view for the user's profile.\r\n\r\nRight now, we have the user's data object available in the global context as `$auth.user`. We want to create a new page that will render some of the user's information like name and email to a profile page.\r\n\r\nBut before we do that, we need to create a different layout for the profile page that will give the user a handy menu to edit their profile. To do this, will create a new layout called `profile` to use on the profile page instead of the `default` layout.\r\n\r\n### Creating the profile page layout\r\n\r\nCreate a new file in the layouts folder named `profile.vue`.\r\n\r\n`layouts/profile.vue`\r\n\r\n```html\r\n<template>\r\n  <v-app>\r\n    <!-- Header Area -->\r\n    <!-- Main Nav -->\r\n    <v-app-bar app elevate-on-scroll>\r\n      <v-app-bar-nav-icon\r\n        class=\"hidden-md-and-up\"\r\n        @click.stop=\"mainMenu = !mainMenu\"\r\n        name=\"menu-open\"\r\n        x-large\r\n      >\r\n        <i aria-hidden=\"true\" class=\"v-icon notranslate theme--dark\">\r\n          <v-icon>{{ mainMenuIcon }}</v-icon>\r\n        </i>\r\n      </v-app-bar-nav-icon>\r\n      <MenuLinks\r\n        :general-links=\"generalLinks\"\r\n        :logged-out-links=\"loggedOutLinks\"\r\n        list-class=\"d-md-flex justify-end hidden-md-and-down ml-auto\"\r\n        list-item-class=\"mx-1\"\r\n      />\r\n      <!-- User Actions Nav (Dropdown) -->\r\n      <v-menu v-model=\"profileMenu\" bottom offset-y>\r\n        <template v-slot:activator=\"{ on }\">\r\n          <v-app-bar-nav-icon\r\n            v-on=\"on\"\r\n            @click.stop=\"profileMenu = !profileMenu\"\r\n            class=\"hidden-md-and-up ml-auto\"\r\n            name=\"profile-edit\"\r\n            x-large\r\n          >\r\n            <i aria-hidden=\"true\" class=\"v-icon notranslate theme--dark\">\r\n              <v-icon>{{ profileMenuIcon }}</v-icon>\r\n            </i>\r\n          </v-app-bar-nav-icon>\r\n        </template>\r\n        <v-list>\r\n          <v-list-item\r\n            v-for=\"(item, index) in items\"\r\n            :key=\"index\"\r\n            @click=\"item.action\"\r\n          >\r\n            <v-list-item-title>{{ item.title }}</v-list-item-title>\r\n          </v-list-item>\r\n          <v-divider />\r\n          <v-list-item @click=\"logout\">\r\n            <v-list-item-title>Logout</v-list-item-title>\r\n          </v-list-item>\r\n        </v-list>\r\n      </v-menu>\r\n    </v-app-bar>\r\n    <!-- side/mobile navigation -->\r\n    <v-navigation-drawer\r\n      v-model=\"mainMenu\"\r\n      app\r\n      disable-resize-watcher\r\n      fixed\r\n      right\r\n    >\r\n      <MenuLinks\r\n        :general-links=\"generalLinks\"\r\n        :logged-out-links=\"loggedOutLinks\"\r\n        list-class=\"d-flex flex-column my-6 mx-3\"\r\n        list-item-class=\"my-3\"\r\n        listItemTitleClass=\"title\"\r\n      />\r\n    </v-navigation-drawer>\r\n    <!-- Nuxt content -->\r\n    <v-main>\r\n      <nuxt />\r\n    </v-main>\r\n    <!-- Footer Area -->\r\n    <v-footer>\r\n      <v-row justify=\"center\">\r\n        <v-col class=\"py-4 text-center\">\r\n          {{ new Date().getFullYear() }} â€” <strong>Adonis Nuxt Starter</strong>\r\n        </v-col>\r\n      </v-row>\r\n    </v-footer>\r\n  </v-app>\r\n</template>\r\n\r\n<script>\r\n  import { mapMutations, mapState } from \"vuex\";\r\n  import {\r\n    mdiAccount,\r\n    mdiAccountPlus,\r\n    mdiEmailEdit,\r\n    mdiFormatListBulletedSquare,\r\n    mdiKey,\r\n    mdiLogin,\r\n    mdiMenu,\r\n    mdiPlusCircle,\r\n    mdiTune,\r\n  } from \"@mdi/js\";\r\n  import MenuLinks from \"../components/MenuLinks\";\r\n  export default {\r\n    name: \"Profile\",\r\n    components: {\r\n      MenuLinks,\r\n    },\r\n    data() {\r\n      return {\r\n        editEmailMode: false,\r\n        editPasswordMode: false,\r\n        editProfileMode: false,\r\n        generalLinks: [\r\n          {\r\n            icon: mdiFormatListBulletedSquare,\r\n            title: \"Resources\",\r\n            to: \"/resources\",\r\n          },\r\n          {\r\n            icon: mdiPlusCircle,\r\n            title: \"Create\",\r\n            to: \"/resources/create\",\r\n          },\r\n        ],\r\n        loggedOutLinks: [\r\n          {\r\n            icon: mdiLogin,\r\n            title: \"Login\",\r\n            to: \"/login\",\r\n          },\r\n          {\r\n            icon: mdiAccountPlus,\r\n            title: \"Register\",\r\n            to: \"/register\",\r\n          },\r\n        ],\r\n        items: [\r\n          {\r\n            action: this.toggleEditProfileMode,\r\n            icon: mdiAccount,\r\n            title: \"Edit Profile\",\r\n          },\r\n          {\r\n            action: this.toggleEditEmailMode,\r\n            icon: mdiEmailEdit,\r\n            title: \"Change Email\",\r\n          },\r\n          {\r\n            action: this.toggleEditPasswordMode,\r\n            icon: mdiKey,\r\n            title: \"Change Password\",\r\n          },\r\n        ],\r\n        mainMenu: false,\r\n        mainMenuIcon: mdiMenu,\r\n        profileMenu: false,\r\n        profileMenuIcon: mdiTune,\r\n      };\r\n    },\r\n    methods: {\r\n      ...mapMutations([\r\n        \"toggleEditEmailMode\",\r\n        \"toggleEditPasswordMode\",\r\n        \"toggleEditProfileMode\",\r\n      ]),\r\n      async logout() {\r\n        await this.$auth.logout();\r\n        this.$toast.success(\"Logged you out\").goAway(2000);\r\n      },\r\n    },\r\n  };\r\n</script>\r\n```\r\n\r\nThis layout moves the main menu to the left side and introduces a profile options menu on the right side. The menu contains links to edit the profile, the email, and the password as well as a logout link. We are using the `mdiTune` icon which signifies edit functions.\r\n\r\nYou may also notice the imported Vuex mutations in the methods section. These simply toggle the edit mode when the links are clicked.\r\n\r\n`store/index.js`\r\n\r\n```javascript\r\nexport const state = () => ({\r\n  editEmailMode: false,\r\n  editPasswordMode: false,\r\n  editProfileMode: false\r\n});\r\n...\r\nexport const mutations = {\r\n...\r\ntoggleEditEmailMode(state) {\r\n    state.editEmailMode = !state.editEmailMode;\r\n    state.editPasswordMode = false;\r\n    state.editProfileMode = false;\r\n  },\r\n  toggleEditPasswordMode(state) {\r\n    state.editEmailMode = false;\r\n    state.editPasswordMode = !state.editPasswordMode;\r\n    state.editProfileMode = false;\r\n  },\r\n  toggleEditProfileMode(state) {\r\n    state.editEmailMode = false;\r\n    state.editPasswordMode = false;\r\n    state.editProfileMode = !state.editProfileMode;\r\n  }\r\n}\r\n...\r\n```\r\n\r\nNotice that in addition to the edit state being toggled the other edit states are turned off to prevent more than one edit form being open at one time.\r\n\r\n### Creating the Profile View\r\n\r\nIn the `pages/users` folder, we want to create a dynamic route `_id.vue` which we will finish shortly.\r\n\r\n#### Adding the edit menu\r\n\r\nWe will then, create a conditionally rendered link in the header that only displays when the user is logged in. This is done using `v-if-\"isAuthenticated`. `isAuthenticated` is a Vuex getter that simply checks if the user is logged in.\r\n\r\nThis link will point to `_id.vue` with the user's id being passed as the dynamic portion of the URL.\r\n\r\nThe link is displayed using the user's profile image for a visual cue that this links to their profile page.\r\n\r\nIn `MenuLinks.vue`:\r\n\r\n```html\r\n<template>\r\n  ...\r\n  <!-- User Profile Link -->\r\n  <v-list-item\r\n    v-if=\"isAuthenticated\"\r\n    class=\"mb-0\"\r\n    :class=\"$breakpoint.mdAndUp ? '' : 'mt-3'\"\r\n    exact\r\n    router\r\n    :to=\"`/users/${this.$auth.user.id}`\"\r\n  >\r\n    <v-avatar size=\"36\">\r\n      <img alt=\"Avatar\" :src=\"this.$auth.user.profile_image_source\" />\r\n    </v-avatar>\r\n  </v-list-item>\r\n  ...\r\n</template>\r\n\r\n<script>\r\n  ...\r\n  computed: {\r\n      ...mapGetters([\"isAuthenticated\"])\r\n    },\r\n  ...\r\n</script>\r\n```\r\n\r\n#### Finishing the user profile view\r\n\r\nNow, let's finish our `_id.vue` component.\r\n\r\n```html\r\n<template>\r\n  <v-container class=\"pa-0\" fill-height fluid>\r\n    <v-row class=\"full-height\" justify=\"center\">\r\n      <!-- User menu navigation -->\r\n      <v-col\r\n        cols=\"12\"\r\n        class=\"py-0 col-md-3\"\r\n        :class=\"$breakpoint.mdAndUp ? '' : 'px-0'\"\r\n      >\r\n        <v-container class=\"d-flex flex-column align-center\">\r\n          <!-- User Avatar -->\r\n          <v-avatar>\r\n            <v-img :src=\"this.$auth.user.profile_image_source\" />\r\n          </v-avatar>\r\n\r\n          <!-- User display info -->\r\n\r\n          <p\r\n            class=\"pt-3 mb-2\"\r\n            :class=\"$breakpoint.mdAndUp ? 'title' : 'display-1'\"\r\n          >\r\n            {{ this.$auth.user.full_name }}\r\n          </p>\r\n          <p\r\n            class=\"font-regular mb-0\"\r\n            :class=\"$breakpoint.mdAndUp ? 'subtitle-2' : 'title'\"\r\n          >\r\n            {{ this.$auth.user.email }}\r\n          </p>\r\n        </v-container>\r\n      </v-col>\r\n\r\n      <!-- User display content -->\r\n      <v-col v-if=\"editEmailMode || editPasswordMode || editProfileMode\">\r\n        <!-- Edit Fields -->\r\n        <v-card\r\n          class=\"mx-auto\"\r\n          color=\"transparent\"\r\n          flat\r\n          :width=\"$breakpoint.mdAndUp ? '50%' : '80vw'\"\r\n        >\r\n          <!-- edit profile fields -->\r\n          <template v-if=\"editProfileMode\">\r\n            <v-text-field\r\n              :value=\"this.$auth.user.first_name\"\r\n              :counter=\"50\"\r\n              :rules=\"nameRules\"\r\n              @input=\"setUserFirstName($event)\"\r\n              label=\"First Name\"\r\n              outlined\r\n            />\r\n\r\n            <v-text-field\r\n              :value=\"this.$auth.user.last_name\"\r\n              :counter=\"50\"\r\n              :rules=\"nameRules\"\r\n              @input=\"setUserLastName($event)\"\r\n              label=\"Last Name\"\r\n              outlined\r\n            />\r\n\r\n            <v-file-input\r\n              v-model=\"userProfileImage\"\r\n              :rules=\"profileImageRules\"\r\n              prepend-icon=\"\"\r\n              :prepend-inner-icon=\"cameraIcon\"\r\n              accept=\"image/png, image/jpeg, image/bmp\"\r\n              clearable\r\n              clear-icon\r\n              placeholder=\"Update your profile picture\"\r\n              show-size\r\n              label=\"Profile Picture\"\r\n              outlined\r\n            />\r\n          </template>\r\n\r\n          <!-- change password fields -->\r\n          <template v-if=\"editPasswordMode\">\r\n            <v-text-field\r\n              v-model=\"updatePassword.old_password\"\r\n              label=\"Old password\"\r\n              placeholder=\"Old Password\"\r\n              type=\"password\"\r\n              autocomplete=\"new-password\"\r\n              outlined\r\n            />\r\n\r\n            <v-text-field\r\n              v-model=\"updatePassword.password\"\r\n              label=\"New Password\"\r\n              placeholder=\"New Password\"\r\n              type=\"password\"\r\n              autocomplete=\"new-password\"\r\n              outlined\r\n            />\r\n\r\n            <v-text-field\r\n              v-model=\"updatePassword.password_confirmation\"\r\n              label=\"Confirm New Password\"\r\n              placeholder=\"Retype New Password\"\r\n              type=\"password\"\r\n              autocomplete=\"new-password\"\r\n              outlined\r\n            />\r\n          </template>\r\n\r\n          <template v-if=\"editEmailMode\">\r\n            <p class=\"body-2\">Current email: {{ this.$auth.user.email }}</p>\r\n            <v-text-field\r\n              v-model=\"updateEmail\"\r\n              :rules=\"emailRules\"\r\n              label=\"New Email\"\r\n              outlined\r\n            />\r\n          </template>\r\n        </v-card>\r\n\r\n        <!-- Edit Profile Action Buttons -->\r\n        <v-container v-if=\"editProfileMode\" class=\"pa-0\">\r\n          <v-row justify=\"center\" align=\"center\">\r\n            <v-col class=\"d-flex justify-center\">\r\n              <!-- Cancel Profile Edit -->\r\n              <v-btn\r\n                @click=\"toggleEditProfileMode\"\r\n                :color=\"editEmailMode ? 'warning' : 'secondary'\"\r\n                class=\"body-2 mr-3\"\r\n                outlined\r\n              >\r\n                Cancel\r\n                <v-icon class=\"ml-2\"\r\n                  >{{ editProfileMode ? accountEditCancelIcon : accountEditIcon\r\n                  }}</v-icon\r\n                >\r\n              </v-btn>\r\n              <!-- Update Event -->\r\n              <v-btn @click=\"updateUserProfileClient\" color=\"primary darken-2\">\r\n                Save\r\n                <v-icon>{{ contentSaveIcon }}</v-icon>\r\n              </v-btn>\r\n            </v-col>\r\n          </v-row>\r\n        </v-container>\r\n\r\n        <!-- Change Password Action Buttons -->\r\n        <v-container v-if=\"editPasswordMode\" class=\"pa-0\">\r\n          <v-row justify=\"center\" align=\"center\">\r\n            <v-col class=\"d-flex justify-center\">\r\n              <!-- Edit/Cancel Change Password -->\r\n              <v-btn\r\n                @click=\"toggleEditPasswordMode\"\r\n                :color=\"editPasswordMode ? 'warning' : 'secondary'\"\r\n                class=\"body-2 mr-3\"\r\n                outlined\r\n              >\r\n                Cancel\r\n                <v-icon class=\"ml-2\"\r\n                  >{{ editPasswordMode ? cancelIcon : accountLockIcon }}</v-icon\r\n                >\r\n              </v-btn>\r\n              <!-- Update Event -->\r\n              <v-btn @click=\"updateUserPasswordClient\" color=\"primary darken-2\">\r\n                Save\r\n                <v-icon>{{ contentSaveIcon }}</v-icon>\r\n              </v-btn>\r\n            </v-col>\r\n          </v-row>\r\n        </v-container>\r\n\r\n        <!-- Change Email Action Buttons -->\r\n        <v-container v-if=\"editEmailMode\" class=\"pa-0\">\r\n          <v-row justify=\"center\" align=\"center\">\r\n            <v-col class=\"d-flex justify-center\">\r\n              <!-- Edit/Cancel Change Email -->\r\n              <v-btn\r\n                @click=\"toggleEditEmailMode\"\r\n                :color=\"editEmailMode ? 'warning' : 'secondary'\"\r\n                class=\"body-2 mr-3\"\r\n                outlined\r\n              >\r\n                Cancel\r\n                <v-icon class=\"ml-2\"\r\n                  >{{ editEmailMode ? cancelIcon : emailEditIcon }}</v-icon\r\n                >\r\n              </v-btn>\r\n              <!-- Update Event -->\r\n              <v-btn @click=\"updateUserEmailClient\" color=\"primary darken-2\">\r\n                Save\r\n                <v-icon>{{ contentSaveIcon }}</v-icon>\r\n              </v-btn>\r\n            </v-col>\r\n          </v-row>\r\n        </v-container>\r\n      </v-col>\r\n      <!-- End Main -->\r\n    </v-row>\r\n  </v-container>\r\n</template>\r\n\r\n<script>\r\n  import { mapActions, mapGetters, mapMutations, mapState } from \"vuex\";\r\n  import {\r\n    mdiAccount,\r\n    mdiAccountCancel,\r\n    mdiAccountEdit,\r\n    mdiAccountKey,\r\n    mdiAccountLock,\r\n    mdiCamera,\r\n    mdiCancel,\r\n    mdiContentSave,\r\n    mdiEmailEdit,\r\n    mdiKey,\r\n  } from \"@mdi/js\";\r\n  import formRulesMixin from \"../../mixins/formRulesMixin\";\r\n  export default {\r\n    layout: \"profile\",\r\n    mixins: [formRulesMixin],\r\n    data() {\r\n      return {\r\n        accountEditIcon: mdiAccountEdit,\r\n        accountEditCancelIcon: mdiAccountCancel,\r\n        accountLockIcon: mdiAccountLock,\r\n        cameraIcon: mdiCamera,\r\n        cancelIcon: mdiCancel,\r\n        contentSaveIcon: mdiContentSave,\r\n        emailEditIcon: mdiEmailEdit,\r\n        updateEmail: \"\",\r\n        updatePassword: {\r\n          old_password: \"\",\r\n          password: \"\",\r\n          password_confirmation: \"\",\r\n        },\r\n        userProfileImage: null,\r\n        valid: true,\r\n      };\r\n    },\r\n    computed: {\r\n      ...mapGetters([\"isAuthenticated\", \"loggedInUser\"]),\r\n      ...mapState([\"editEmailMode\", \"editPasswordMode\", \"editProfileMode\"]),\r\n      ...mapState(\"resource\", [\"userResources\"]),\r\n    },\r\n    mounted() {\r\n      this.fetchResourcesByUser();\r\n    },\r\n    methods: {\r\n      ...mapActions([\r\n        \"updateUserProfile\",\r\n        \"updateUserPassword\",\r\n        \"updateUserEmail\",\r\n      ]),\r\n      ...mapActions(\"resource\", [\"fetchResourcesByUser\"]),\r\n      titleCase(string) {\r\n        return titleCase(string);\r\n      },\r\n      ...mapMutations([\r\n        \"setEditEmailMode\",\r\n        \"setEditPasswordMode\",\r\n        \"setEditProfileMode\",\r\n        \"setUserFirstName\",\r\n        \"setUserLastName\",\r\n        \"toggleEditEmailMode\",\r\n        \"toggleEditPasswordMode\",\r\n        \"toggleEditProfileMode\",\r\n      ]),\r\n      updateUserEmailClient() {\r\n        this.updateUserEmail({ email: this.updateEmail });\r\n        this.setEditEmailMode(false);\r\n      },\r\n      updateUserProfileClient() {\r\n        this.updateUserProfile({\r\n          user: this.$auth.user,\r\n          profileImage: this.userProfileImage,\r\n        });\r\n        this.setEditProfileMode(false);\r\n      },\r\n      updateUserPasswordClient() {\r\n        this.updateUserPassword(this.updatePassword);\r\n        this.setEditPasswordMode(false);\r\n      },\r\n    },\r\n  };\r\n</script>\r\n\r\n<style lang=\"scss\">\r\n  .profile-card {\r\n    display: flex;\r\n    flex-direction: column;\r\n    align-items: center;\r\n    margin: 0 auto;\r\n    width: 80vw;\r\n\r\n    p:first-of-type {\r\n      font-size: 1.5rem;\r\n      font-weight: 500;\r\n      margin: 1rem 0 0.75rem;\r\n    }\r\n\r\n    p {\r\n      font-size: 1.25rem;\r\n      font-weight: 300;\r\n    }\r\n  }\r\n\r\n  .profile-edit-button {\r\n    top: 0;\r\n    right: -15px;\r\n  }\r\n\r\n  .profile-save-button {\r\n    top: 0;\r\n    right: -60px;\r\n  }\r\n\r\n  @media screen and (min-width: 768px) {\r\n    .profile-card {\r\n      width: 50vw;\r\n    }\r\n  }\r\n</style>\r\n```\r\n\r\n#### Breaking down the profile view\r\n\r\nThere is a lot going on here so let's step through it.\r\n\r\nFirst, in the template, we are creating a basic user profile display showing the user's profile image, full name and email.\r\n\r\nNext, each edit form is listed to be conditionally displayed when the edit mode for that function is set to true. The edit mode will be toggled by clicking the link in the profile options menu at the top right of the screen.\r\n\r\nEach of these forms contain the fields that need to be completed for an edit to occur. The profile edit form is an exception from this as all it's fields are optional.\r\n\r\nWhen these forms are open, a cancel and save button will appear for the user to either abort the edit or save the changes.\r\n\r\nThe user can edit their first and last names and profile image in the profile edit form. The Nuxt auth user object is used to set the value of each field dynamically. When an input event occurs a Vuex mutation is called and passed the event. For example, when the first name field is edited the `setUserFirstName` mutation is called and passed the entered string as `$event`. This will in turn update the user's first name in the `auth.user` object.\r\n\r\n> In plain JavaScript you may be used to getting the event value with `event.target.value` however in Vue the value is contained in `$event`.\r\n\r\n`store/index.js`\r\n\r\n```javascript\r\n...\r\nexport const mutations = {\r\n  ...\r\n  setUserFirstName(state, first_name) {\r\n    state.auth.user.first_name = first_name;\r\n  },\r\n  setUserLastName(state, last_name) {\r\n    state.auth.user.last_name = last_name;\r\n  },\r\n  ...\r\n}\r\n...\r\n```\r\n\r\nThe profile image is more complicated as we are allowing the user to upload a new file. We are using Vuetify's v-file-input component to do this which will set the local state variable `userProfileImage` to the image object. `userProfileImage` will be passed with the `auth.user` object to a Vuex action to update this information server side.\r\n\r\n#### Updating the user profile\r\n\r\nOnce the user has changed the profile edit fields to their liking, the save button can be clicked to call the `updateUserProfileClient` method.\r\n\r\n```javascript\r\nupdateUserProfileClient() {\r\n  this.updateUserProfile({\r\n    user: this.$auth.user,\r\n    profileImage: this.userProfileImage,\r\n  });\r\n  this.setEditProfileMode(false);\r\n},\r\n```\r\n\r\nHere we are passing the updated info to Vuex to send to the server and setting the edit mode to false which closes the form.\r\n\r\n`store/index.js`\r\n\r\n```javascript\r\nexport const actions = {\r\n  // update a user's edited profile\r\n  async updateUserProfile({ commit, dispatch }, { user, profileImage }) {\r\n    // add image to static folder before update user profile\r\n    dispatch(\"updateProfilePic\", profileImage);\r\n    await this.$axios\r\n      .$patch(\"/auth/update\", user)\r\n      .then((response) => {\r\n        this.$auth.setUser(response);\r\n        this.$toast.success(\"Profile updated...\").goAway(3000);\r\n      })\r\n      .catch((error) => console.log(error));\r\n  },\r\n\r\n  // sync add new user photo to images folder and update user profile image source\r\n  updateProfilePic({ commit }, profileImage) {\r\n    // new images must be post to Adonis via form data through axios\r\n    let formData = new FormData();\r\n    formData.append(\"profileImage\", profileImage);\r\n    let url = \"/auth/update/profile-pic\";\r\n    let config = {\r\n      headers: {\r\n        \"content-type\": \"multipart/form-data\",\r\n      },\r\n    };\r\n    this.$axios({\r\n      method: \"post\",\r\n      url: url,\r\n      data: formData,\r\n      config: config,\r\n    })\r\n      .then((response) => {\r\n        commit(\"setUserProfileImageSource\", response.data.profile_image_source);\r\n      })\r\n      .catch((e) => console.log(error));\r\n  },\r\n};\r\n```\r\n\r\nLet's look at the `updateUserProfile` function first. Since the `updateProfilePic` function is also an action in the same file, we must call it using Vuex's `dispatch` function. We'll go over this function in more depth shortly but, for now, suffice to say it sends the new image to the server for processing. We are sending a PATCH request to the server at `/auth/update` with the user object and profile image as the request payload.\r\n\r\nThis triggers the `update` method in the `UserController`, which is shown below.\r\n\r\n```javascript\r\n\"use strict\";\r\nconst Env = use(\"Env\");\r\nconst Helpers = use(\"Helpers\");\r\nconst Persona = use(\"Persona\");\r\nconst User = use(\"App/Models/User\");\r\n\r\nclass UserController {\r\n  ...\r\n  async update({ request, auth }) {\r\n    const user = await auth.getUser();\r\n    const payload = request.only([\"first_name\", \"last_name\"]);\r\n    // create full name field\r\n    payload.full_name = `${payload.first_name} ${payload.last_name}`;\r\n    await Persona.updateProfile(user, payload);\r\n    const updatedUser = await auth.getUser();\r\n    return updatedUser;\r\n  }\r\n  ...\r\n}\r\n```\r\n\r\nThis method gets the current user and the request payload and uses it to update the user profile using the `Persona.updateProfile` method. Once updated, the updated user is fetched and sent as the response to the client.\r\n\r\nBack in the Vuex action `updateUserProfile`, the response is used to update the user data on the client-side and display a Toast notification informing the user the profile has been updated.\r\n\r\n#### Updating the profile image\r\n\r\nNow, let's look at how the profile image is updated.\r\n\r\n```javascript\r\n// sync add new user photo to images folder and update user profile image source\r\n  updateProfilePic({ commit }, profileImage) {\r\n    // new images must be post to Adonis via form data through axios\r\n    let formData = new FormData();\r\n    formData.append(\"profileImage\", profileImage);\r\n    let url = \"/auth/update/profile-pic\";\r\n    let config = {\r\n      headers: {\r\n        \"content-type\": \"multipart/form-data\",\r\n      },\r\n    };\r\n    this.$axios({\r\n      method: \"post\",\r\n      url: url,\r\n      data: formData,\r\n      config: config,\r\n    })\r\n      .then((response) => {\r\n        commit(\"setUserProfileImageSource\", response.data.profile_image_source);\r\n      })\r\n      .catch((e) => console.log(error));\r\n  },\r\n```\r\n\r\nBecause we are uploading a file to the server, we need to use a [Form Data object](https://developer.mozilla.org/en-US/docs/Web/API/FormData/FormData) instead of a plain javascript object. This lets us append the file to the request using Axios options and send it to the server for use in the controller method.\r\n\r\nThis routes calls the `updateProfilePic` in the `UserController`.\r\n\r\n```javascript\r\nasync updateProfilePic({ request, auth }) {\r\n    const user = await auth.user;\r\n    // create file from client upload\r\n    const file = await request.file(\"profileImage\");\r\n    // if file is not null or undefined, move the image file to the static/images folder\r\n    if (file) {\r\n      // move the image to the public images folder and name with format `first-last-1.filetype` (ex. jeremy-bratcher-1.jpg) overwriting any images with the same name\r\n      await file.move(Helpers.appRoot(\"public/images\"), {\r\n        name: `${user.first_name}-${user.last_name}-${user.id}.${file.subtype}`,\r\n        overwrite: true,\r\n      });\r\n      // if the file wasn't able to be moved, respond to client with the error response\r\n      if (!file.moved()) {\r\n        return file.error();\r\n      }\r\n      // Update the image link in the user's image source column\r\n      user.profile_image_source = `${Env.get(\"APP_URL\")}/images/${\r\n        user.first_name\r\n      }-${user.last_name}-${user.id}.${file.subtype}`;\r\n      user.save();\r\n      return user;\r\n    }\r\n    // if there in no file, log message and return\r\n    return \"No file uploaded\";\r\n  }\r\n```\r\n\r\nIn the controller method, we are moving the upload file to a public folder to display on the client-side. The user's information is used to create the file name. Then, the profile image source is updated in the user table for that user. Finally, the user data object is returned to the client to sync the new profile image source URL with the database. If there is an issue moving the file, an error is returned. If no file is uploaded, a console log statement is made reflecting that.\r\n\r\nOnce the response is received, we will use that to updated the profile image source.\r\n\r\nYou can learn more about file uploads and handling image files with Adonis at the links below.\r\n\r\n[Updating the user profile image](https://forum.adonisjs.com/t/upload-image-using-axios-vue-js-adonisjs-rest/2594/10)\r\n\r\n[Adonis File Uploads](https://adonisjs.com/docs/4.1/file-uploads)\r\n\r\nThat was a lot of work but we can now freely update the user profile information and profile image at will.\r\n\r\n## Change Email\r\n\r\nLike the profile edit option, we have already seen the email form fields and this function works in a similar way. In addition to updating the email address when a change is made, we want to email the user to confirm this change to enhance the security of our app.\r\n\r\nIf we refer to the `_id.vue` page above, we can see that `v-model` is used on the email input to update the local variable `updateEmail`. When the save button is clicked, `updateEmail` is passed to `updateUserEmailClient` which calls a Vuex action and the email edit mode is set to `false`.\r\n\r\nThe related Vuex action `updateUserEmail` is called and will handle the axios call to the `UserController`.\r\n\r\n`store/index.js`\r\n\r\n```javascript\r\n// update a user's email address with verification\r\n  async updateUserEmail({ commit, dispatch }, updatedEmail) {\r\n    await this.$axios\r\n      .$patch(\"/auth/update/email\", updatedEmail)\r\n      .then(response => {\r\n        this.$auth.setUser(response);\r\n        this.$toast.success(\"Email updated...\").goAway(3000);\r\n      })\r\n      .catch(error => {\r\n        this.$toast\r\n          .error(`Email update error: ${error.response.data[0].message}`)\r\n          .goAway(5000);\r\n      });\r\n  },\r\n```\r\n\r\n`app/UserController`\r\n\r\n```javascript\r\nasync updateEmail({ request, auth }) {\r\n    const payload = request.only([\"email\"]);\r\n    const user = await auth.user;\r\n    const updatedUser = await Persona.updateProfile(user, payload);\r\n    return updatedUser;\r\n  }\r\n```\r\n\r\nNotice that `updateEmail` and `update` both use `Persona.updateProfile`. When `Persona.updateProfile` is used to update the email a few things happen.\r\n\r\n- Sets the user's account_status = pending.\r\n- Generates an email verification token.\r\n- Fires the email::changed event.\r\n\r\nDue to security risks involved in changing a user's email, the account status is set to pending, a verification token is generated, and an event is triggered.\r\n\r\nWe want to confirm with the user via email that they made this request and will use the token to verify the request.\r\n\r\nUsing the fired event, we will send an email in a similar fashion to the new user email.\r\n\r\n`app/start/events.js`\r\n\r\n```javascript\r\nEvent.on(\"email::changed\", async (payload) => {\r\n  const user = payload.user.toJSON();\r\n  const token = querystring.encode({\r\n    token: payload.token,\r\n  });\r\n\r\n  await Mail.send(\"update.email\", { host, token, user }, (message) => {\r\n    message\r\n      .to(payload.user.email)\r\n      .from(`<${Env.get(\"MAIL_USERNAME\")}>`)\r\n      .subject(\"Email Change Confirmation\");\r\n  });\r\n});\r\n```\r\n\r\n`resources/update/email.edge`\r\n\r\n```html\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n  <head>\r\n    <meta charset=\"UTF-8\" />\r\n    <title>Email Updated</title>\r\n  </head>\r\n  <body>\r\n    <section>\r\n      <p>Email Change Request</p>\r\n      <p>\r\n        Hi, {{ user.full_name }}.\r\n      </p>\r\n      <p>\r\n        This message is to notify you that your email has been updated on your\r\n        account. To confirm this change, please click on the link below.\r\n      </p>\r\n      <a href=\"{{host}}/users/verify-email?{{token}}\">Verify your new email</a>\r\n    </section>\r\n  </body>\r\n</html>\r\n```\r\n\r\nThis will send an email to the user's original email address to confirm the change. Note we are using the same link to verify this change as we used to verify the email of new users.\r\n\r\n## Change Password\r\n\r\nLetting the user change their password during an authenticated session is a useful way to offer a password reset while they are already logged in. This is done in a similar manner to the change email function as it affects the security of the user's account.\r\n\r\nBack in `_id.vue`, the password change inputs take the old password, the new password, and a confirmation of the new password. This is store in a local state object, `updatePassword` which is passed to `updateUserPasswordClient` when the form is saved. The related Vuex action is `updateUserPassword` which passes the object to the `UserController`\r\n\r\n`store/index.js`\r\n\r\n```javascript\r\n// change password from user profile\r\n  async updateUserPassword({ commit }, updatePassword) {\r\n    await this.$axios\r\n      .$patch(\"/auth/update/password\", updatePassword)\r\n      .then(response => {\r\n        this.$toast.success(\"Password changed...\").goAway(3000);\r\n      })\r\n      .catch(error => console.log(error));\r\n  },\r\n```\r\n\r\n`app/Controllers/Http/UserController.js`\r\n\r\n```javascript\r\nasync updatePassword({ request, auth }) {\r\n  const payload = request.only([\r\n    \"old_password\",\r\n    \"password\",\r\n    \"password_confirmation\",\r\n  ]);\r\n  const user = await auth.getUser();\r\n  const updatedUser = await Persona.updatePassword(user, payload);\r\n  return updatedUser;\r\n}\r\n```\r\n\r\n`Persona.updatePassword` will fire an event `password::changed`. We will use this event to send a notification email to the user that their email has been changed. This is to prevent any unauthorized changes to the account when a hacker is trying to change the user's password to lock them out of the account.\r\n\r\n`start/events.js`\r\n\r\n```javascript\r\nEvent.on(\"password::changed\", async (payload) => {\r\n  const user = payload.user.toJSON();\r\n\r\n  await Mail.send(\"update.password\", { user }, (message) => {\r\n    message\r\n      .to(payload.user.email)\r\n      .from(`<${Env.get(\"MAIL_USERNAME\")}>`)\r\n      .subject(\"Password Change Notifcation\");\r\n  });\r\n});\r\n```\r\n\r\n`resources/update/password.edge`\r\n\r\n```html\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n  <head>\r\n    <meta charset=\"UTF-8\" />\r\n    <title>Password Change Request</title>\r\n  </head>\r\n  <body>\r\n    <section>\r\n      <p>Password Changed Confirmatioon</p>\r\n      <p>\r\n        Hi, {{ user.full_name }}.\r\n      </p>\r\n      <p>\r\n        This message is to notify you that the password has been updated on your\r\n        account. If this was you, no further action is needed.\r\n      </p>\r\n    </section>\r\n  </body>\r\n</html>\r\n```\r\n\r\nOn the client-side, the response will trigger a Toast message indicating the user's password has been changed.\r\n\r\n## Conclusion\r\n\r\nOnce these steps are completed, you should have full-functional and robust user module for your application. Most applications need user account management features so this will help for sure.\r\n\r\nThe code for this series is part of my ongoing project in developing a starter kit that uses Nuxt and Adonis. The link below will take you to that repo on Github.\r\n\r\n[Adonis Nuxt Starter](https://github.com/jbratcher/Adonis-Nuxt-Starter)\r\n",
  "description": "Profile Editing / Change Email / Change Password",
  "thumbnail": "/img/adonis-nuxt-starter.svg",
  "hero": "/img/adonis-nuxt-starter.svg"
}